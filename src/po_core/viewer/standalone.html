<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Po_core: Companions Viewer</title>
  <style>
    :root {
      --bg:      #0d1117;
      --panel:   #161b22;
      --text:    #c9d1d9;
      --muted:   #8b949e;
      --blue:    #58a6ff;
      --green:   #3fb950;
      --red:     #f85149;
      --purple:  #d2a8ff;
      --yellow:  #e3b341;
      --border:  #30363d;
      --badge:   rgba(255,255,255,0.05);
    }

    /* â”€â”€ Kirakira â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes rainbow-bg   { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
    @keyframes rainbow-bdr  { 0%,100%{border-color:#ff5858;box-shadow:0 0 12px #ff5858} 33%{border-color:#58a6ff;box-shadow:0 0 12px #58a6ff} 66%{border-color:#3fb950;box-shadow:0 0 12px #3fb950} }
    @keyframes float        { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }

    body.kirakira { background:linear-gradient(-45deg,#1a0b2e,#0d1117,#0b1a2e,#112211);background-size:400% 400%;animation:rainbow-bg 15s ease infinite; }
    body.kirakira .panel { animation:rainbow-bdr 5s linear infinite;background:rgba(22,27,34,.85);backdrop-filter:blur(5px); }
    body.kirakira #title-accent { background:linear-gradient(to right,#ff8a00,#e52e71,#58a6ff,#3fb950);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:rainbow-bg 3s linear infinite;background-size:200% 200%; }
    body.kirakira .phil-badge { animation:float 2s ease-in-out infinite;border-color:rgba(255,255,255,.25); }
    body.kirakira .phil-badge:nth-child(odd)  { animation-delay:.5s; }
    body.kirakira .phil-badge:nth-child(3n)   { animation-delay:1s; }
    body.kirakira .terminal  { background:rgba(1,4,9,.7);box-shadow:inset 0 0 20px rgba(88,166,255,.15); }
    body.kirakira .phil-badge.active { background:rgba(255,255,255,.2);border-color:#fff;box-shadow:0 0 14px rgba(255,255,255,.7),inset 0 0 8px rgba(255,255,255,.4);color:#fff;font-weight:bold; }
    body.kirakira .phil-badge.active .dot { background:#fff;box-shadow:0 0 6px #fff; }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Consolas','Courier New',monospace;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 12px;
      gap: 10px;
      overflow: hidden;
      transition: background 1s ease;
    }

    /* â”€â”€ Header â”€â”€â”€ */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 18px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all .5s;
      flex-shrink: 0;
    }
    header h1 { font-size: 1.25rem; letter-spacing: 1px; }
    #title-accent { color: var(--blue); transition: all .5s; }

    .header-right { display: flex; align-items: center; gap: 14px; font-size: .82rem; }
    #sys-status { color: var(--green); font-weight: bold; }
    #session-label { color: var(--muted); }
    #session-id-val { color: var(--purple); font-size: .78rem; cursor: pointer; }
    #session-id-val:hover { color: var(--text); }

    /* Mode toggle */
    .mode-btn {
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 3px 12px;
      font-size: .78rem;
      font-weight: bold;
      cursor: pointer;
      background: var(--badge);
      color: var(--muted);
      transition: all .25s;
    }
    .mode-btn.live { border-color: var(--green); color: var(--green); background: rgba(63,185,80,.12); }

    /* Settings bar */
    #settings-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: .8rem;
      flex-shrink: 0;
      transition: all .3s;
    }
    #settings-bar label { color: var(--muted); }
    #api-url-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 3px 8px;
      border-radius: 4px;
      font-family: inherit;
      font-size: .8rem;
    }
    #api-url-input:focus { outline: none; border-color: var(--blue); }
    .small-btn {
      border: 1px solid var(--border);
      background: var(--badge);
      color: var(--muted);
      padding: 3px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: .78rem;
      transition: all .2s;
    }
    .small-btn:hover { border-color: var(--text); color: var(--text); }

    /* â”€â”€ Dashboard â”€â”€â”€ */
    .dashboard {
      display: grid;
      grid-template-columns: 260px 1fr 300px;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all .5s;
    }
    .panel-hdr {
      padding: 10px 14px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid var(--border);
      font-weight: bold;
      font-size: .88rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .panel-body { padding: 14px; overflow-y: auto; flex: 1; }

    /* â”€â”€ Tensors â”€â”€â”€ */
    .tensor-group { margin-bottom: 18px; }
    .tensor-lbl { display: flex; justify-content: space-between; font-size: .82rem; margin-bottom: 6px; color: var(--muted); }
    .bar-bg { width: 100%; height: 5px; background: var(--bg); border-radius: 3px; overflow: hidden; }
    .bar-fill { height: 100%; width: 0; transition: width .7s cubic-bezier(.4,0,.2,1); }
    .fp  { background: var(--blue); }
    .sd  { background: var(--purple); }
    .bt  { background: var(--red); }

    .gate-box {
      margin-top: 24px;
    }
    .gate-lbl { font-size: .82rem; font-weight: bold; color: var(--text); margin-bottom: 8px; }
    .gate-row {
      font-size: .82rem;
      padding: 7px 10px;
      margin-bottom: 5px;
      background: var(--bg);
      border-radius: 4px;
      border-left: 3px solid var(--border);
      color: var(--muted);
      transition: all .3s;
    }
    .gate-row.pass  { border-color: var(--green); color: var(--text); }
    .gate-row.block { border-color: var(--red);   color: var(--red); }

    .result-box {
      margin-top: 20px;
    }
    .result-lbl { font-size: .82rem; font-weight: bold; color: var(--text); margin-bottom: 8px; }
    .result-status {
      font-size: .82rem;
      padding: 7px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: var(--bg);
      transition: all .3s;
    }
    .result-status.approved { border-color: var(--green); color: var(--green); }
    .result-status.blocked  { border-color: var(--red);   color: var(--red); }
    .result-status.fallback { border-color: var(--yellow); color: var(--yellow); }
    #proc-time { font-size: .75rem; color: var(--muted); margin-top: 5px; }

    /* â”€â”€ Middle panel â”€â”€â”€ */
    .mid-body {
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    .input-area { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; flex-shrink: 0; }
    textarea {
      width: 100%;
      height: 80px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px;
      border-radius: 6px;
      resize: none;
      font-family: inherit;
      font-size: .9rem;
    }
    textarea:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 1px var(--blue); }
    #run-btn {
      background: var(--text);
      color: var(--bg);
      border: none;
      padding: 10px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: .9rem;
      font-family: inherit;
      transition: all .2s;
    }
    #run-btn:hover:not(:disabled)  { background: #fff; transform: translateY(-1px); }
    #run-btn:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; transform: none; }

    .terminal {
      background: #010409;
      flex: 1;
      min-height: 0;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      overflow-y: auto;
      font-size: .86rem;
      line-height: 1.55;
      transition: all .5s;
    }
    .t-sys   { color: var(--muted); }
    .t-step  { color: var(--text); font-weight: bold; border-bottom: 1px dotted var(--border); display: inline-block; margin: 8px 0 4px; }
    .t-talk  { margin: 6px 0 6px 8px; padding-left: 10px; border-left: 2px solid var(--border); }
    .t-name  { font-weight: bold; color: var(--blue); margin-right: 4px; }
    .t-weight{ font-size: .75rem; color: var(--muted); margin-left: 4px; }
    .t-final {
      background: rgba(88,166,255,.08);
      border: 1px solid rgba(88,166,255,.2);
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .t-err   { color: var(--red); }
    .t-warn  { color: var(--yellow); }

    /* â”€â”€ Right: Battalion â”€â”€â”€ */
    .roster-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 5px;
      align-content: start;
    }
    .phil-badge {
      padding: 5px 8px;
      font-size: .73rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--muted);
      background: var(--badge);
      transition: all .3s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      cursor: default;
    }
    .phil-badge .name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .phil-badge .weight-val { font-size: .68rem; color: var(--muted); flex-shrink: 0; }
    .dot { width: 5px; height: 5px; border-radius: 50%; background: var(--border); transition: background .3s; flex-shrink: 0; }
    .phil-badge.active { background: rgba(88,166,255,.15); border-color: var(--blue); color: #fff; box-shadow: 0 0 8px rgba(88,166,255,.35); }
    .phil-badge.active .dot { background: var(--blue); box-shadow: 0 0 4px var(--blue); }
    .phil-badge.planned { opacity: .45; font-style: italic; }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <h1>Po_core <span id="title-accent">/ Synthetic Thought Architect</span></h1>
    <div class="header-right">
      <span id="companion-count" style="color:var(--muted)">Companions: â€”</span>
      <span id="session-label">Session: <span id="session-id-val" title="ã‚¯ãƒªãƒƒã‚¯ã§æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³" onclick="newSession()">â€”</span></span>
      <span id="sys-status">System: â€”</span>
      <button class="mode-btn" id="mode-btn" onclick="toggleMode()">DEMO</button>
    </div>
  </header>

  <!-- Settings bar (Live mode only) -->
  <div id="settings-bar">
    <label for="api-url-input">API:</label>
    <input id="api-url-input" type="text" value="http://localhost:8000" spellcheck="false" />
    <button class="small-btn" onclick="pingHealth()">Ping</button>
    <button class="small-btn" onclick="newSession()">New Session</button>
    <span id="ping-result" style="color:var(--muted);font-size:.78rem;"></span>
  </div>

  <!-- Dashboard -->
  <div class="dashboard">

    <!-- Left: System State -->
    <div class="panel">
      <div class="panel-hdr">System State</div>
      <div class="panel-body">

        <div class="tensor-group">
          <div class="tensor-lbl"><span>Freedom Pressure</span><span id="val-fp">â€”</span></div>
          <div class="bar-bg"><div class="bar-fill fp" id="bar-fp"></div></div>
        </div>
        <div class="tensor-group">
          <div class="tensor-lbl"><span>Semantic Delta</span><span id="val-sd">â€”</span></div>
          <div class="bar-bg"><div class="bar-fill sd" id="bar-sd"></div></div>
        </div>
        <div class="tensor-group">
          <div class="tensor-lbl"><span>Blocked Tensor</span><span id="val-bt">â€”</span></div>
          <div class="bar-bg"><div class="bar-fill bt" id="bar-bt"></div></div>
        </div>

        <div class="gate-box">
          <div class="gate-lbl">W_Ethics Gates</div>
          <div class="gate-row" id="gate-intent">Intention Gate: â€”</div>
          <div class="gate-row" id="gate-action">Action Gate: â€”</div>
        </div>

        <div class="result-box">
          <div class="result-lbl">Verdict</div>
          <div class="result-status" id="verdict-box">WAITING</div>
          <div id="proc-time"></div>
        </div>

      </div>
    </div>

    <!-- Middle: Deliberation Engine -->
    <div class="panel">
      <div class="panel-hdr">Deliberation Engine</div>
      <div class="mid-body">
        <div class="input-area">
          <textarea id="prompt-input" placeholder="ç‹¬ã‚Šã§æ±ºã‚ãã‚Œãªã„è‘›è—¤ã‚„å•ã„ã‚’æŠ•ã’ã¦ã¿ã¦ãã ã•ã„ã€‚ä»²é–“ãŸã¡ãŒå…±ã«è€ƒãˆã¾ã™ã€‚"></textarea>
          <button id="run-btn" onclick="runCore()">Deliberate â€” è­°è«–é–‹å§‹</button>
        </div>
        <div class="terminal" id="terminal">
          <div class="t-sys">Po_core Engine ready.</div>
          <div class="t-sys">Companions are listening.</div>
        </div>
      </div>
    </div>

    <!-- Right: The Battalion -->
    <div class="panel">
      <div class="panel-hdr">
        <span>The Battalion</span>
        <span id="active-count" style="color:var(--muted);font-weight:normal">0 Active</span>
      </div>
      <div class="panel-body">
        <div class="roster-grid" id="roster"></div>
      </div>
    </div>

  </div><!-- /.dashboard -->

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Constants
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Mapping: API display name (lowercase fragment) â†’ roster key
    // Build from manifest data: philosopher_id|display_name
    const PHILOSOPHER_DATA = [
      { id:"kant",          name:"Kant",          apiName:"Immanuel Kant" },
      { id:"confucius",     name:"Confucius",      apiName:"Confucius (å­”å­)" },
      { id:"marcus_aurelius",name:"M.Aurelius",   apiName:"Marcus Aurelius" },
      { id:"jonas",         name:"Jonas",          apiName:"Hans Jonas" },
      { id:"weil",          name:"Weil",           apiName:"Simone Weil" },
      { id:"levinas",       name:"Levinas",        apiName:"Emmanuel Levinas" },
      { id:"watsuji",       name:"Watsuji",        apiName:"å’Œè¾»å“²éƒ (Watsuji TetsurÅ)" },
      { id:"dogen",         name:"Dogen",          apiName:"Dogen Zenji (é“å…ƒç¦…å¸«)" },
      { id:"wabi_sabi",     name:"Wabi-Sabi",      apiName:"ä¾˜ã³å¯‚ã³ (Wabi-Sabi)" },
      { id:"aristotle",     name:"Aristotle",      apiName:"Aristotle (á¼ˆÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»Î·Ï‚)" },
      { id:"plato",         name:"Plato",          apiName:"Plato (Î Î»Î¬Ï„Ï‰Î½)" },
      { id:"descartes",     name:"Descartes",      apiName:"RenÃ© Descartes" },
      { id:"spinoza",       name:"Spinoza",        apiName:"Baruch Spinoza" },
      { id:"hegel",         name:"Hegel",          apiName:"Georg Wilhelm Friedrich Hegel" },
      { id:"husserl",       name:"Husserl",        apiName:"Edmund Husserl" },
      { id:"merleau_ponty", name:"Merleau-Ponty",  apiName:"Maurice Merleau-Ponty" },
      { id:"wittgenstein",  name:"Wittgenstein",   apiName:"Ludwig Wittgenstein" },
      { id:"peirce",        name:"Peirce",         apiName:"Charles Sanders Peirce" },
      { id:"dewey",         name:"Dewey",          apiName:"John Dewey" },
      { id:"arendt",        name:"Arendt",         apiName:"Hannah Arendt" },
      { id:"beauvoir",      name:"Beauvoir",       apiName:"Simone de Beauvoir" },
      { id:"nishida",       name:"Nishida",        apiName:"è¥¿ç”°å¹¾å¤šéƒ (Nishida KitarÅ)" },
      { id:"laozi",         name:"Laozi",          apiName:"Laozi" },
      { id:"zhuangzi",      name:"Zhuangzi",       apiName:"Zhuangzi (èŠå­)" },
      { id:"nagarjuna",     name:"Nagarjuna",      apiName:"Nagarjuna" },
      { id:"parmenides",    name:"Parmenides",     apiName:"Parmenides" },
      { id:"epicurus",      name:"Epicurus",       apiName:"Epicurus" },
      { id:"jung",          name:"Jung",           apiName:"Carl Gustav Jung" },
      { id:"nietzsche",     name:"Nietzsche",      apiName:"Friedrich Nietzsche" },
      { id:"heidegger",     name:"Heidegger",      apiName:"Martin Heidegger" },
      { id:"sartre",        name:"Sartre",         apiName:"Jean-Paul Sartre" },
      { id:"kierkegaard",   name:"Kierkegaard",    apiName:"SÃ¸ren Kierkegaard" },
      { id:"schopenhauer",  name:"Schopenhauer",   apiName:"Arthur Schopenhauer" },
      { id:"foucault",      name:"Foucault",       apiName:"Michel Foucault" },
      { id:"derrida",       name:"Derrida",        apiName:"Jacques Derrida" },
      { id:"deleuze",       name:"Deleuze",        apiName:"Gilles Deleuze" },
      { id:"lacan",         name:"Lacan",          apiName:"Jacques Lacan" },
      { id:"badiou",        name:"Badiou",         apiName:"Alain Badiou" },
      { id:"butler",        name:"Butler",         apiName:"Judith Butler" },
      // AI Companions
      { id:"grok_xai",      name:"Grok",           apiName:"Grok (xAI)" },
      { id:"gemini_google", name:"Gemini",         apiName:"Gemini (Google)" },
      { id:"gpt_chatgpt",   name:"GPT",            apiName:"GPT (OpenAI)" },
      { id:"claude_anthropic", name:"Claude",      apiName:"Claude (Anthropic)" },
    ];

    // Sorted alphabetically for roster display
    const SORTED = [...PHILOSOPHER_DATA].sort((a, b) => a.name.localeCompare(b.name));

    // Reverse lookup: lowercase api name â†’ philosopher id
    const API_NAME_MAP = {};
    PHILOSOPHER_DATA.forEach(p => {
      API_NAME_MAP[p.apiName.toLowerCase()] = p.id;
      // also partial: last word of the name
      API_NAME_MAP[p.name.toLowerCase()] = p.id;
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  State
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let isLive = localStorage.getItem('po_live') === '1';
    let sessionId = localStorage.getItem('po_session') || null;
    const badgeMap = {}; // id â†’ DOM element

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Init
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function init() {
      buildRoster();
      applyMode();
      updateSessionLabel();
      document.getElementById('companion-count').innerText = `Companions: ${PHILOSOPHER_DATA.filter(p=>!p.planned).length}`;
    }

    function buildRoster() {
      const grid = document.getElementById('roster');
      SORTED.forEach(p => {
        const el = document.createElement('div');
        el.className = 'phil-badge' + (p.planned ? ' planned' : '');
        el.title = p.apiName + (p.planned ? '  [Coming Soon]' : '');
        el.innerHTML = `
          <div class="dot"></div>
          <span class="name">${p.name}</span>
          <span class="weight-val" id="wv-${p.id}"></span>`;
        grid.appendChild(el);
        badgeMap[p.id] = el;
      });
    }

    function applyMode() {
      const btn = document.getElementById('mode-btn');
      const bar = document.getElementById('settings-bar');
      const status = document.getElementById('sys-status');
      if (isLive) {
        btn.classList.add('live');
        btn.innerText = 'LIVE';
        bar.style.display = '';
        status.style.color = 'var(--green)';
        status.innerText = 'System: Connected';
      } else {
        btn.classList.remove('live');
        btn.innerText = 'DEMO';
        bar.style.display = 'none';
        status.style.color = 'var(--yellow)';
        status.innerText = 'System: Demo';
      }
    }

    function toggleMode() {
      isLive = !isLive;
      localStorage.setItem('po_live', isLive ? '1' : '0');
      applyMode();
      appendLog(`<div class="t-sys">Mode switched to: ${isLive ? 'LIVE (API)' : 'DEMO (simulation)'}</div>`);
    }

    function newSession() {
      sessionId = null;
      localStorage.removeItem('po_session');
      updateSessionLabel();
      appendLog('<div class="t-sys">Session reset. Next run will start a new session.</div>');
    }

    function updateSessionLabel() {
      const el = document.getElementById('session-id-val');
      if (sessionId) {
        el.innerText = sessionId.slice(0, 8) + 'â€¦';
        el.title = sessionId + '\n(ã‚¯ãƒªãƒƒã‚¯ã§æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³)';
      } else {
        el.innerText = '(new)';
        el.title = 'ã‚¯ãƒªãƒƒã‚¯ã§æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Utilities
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const term = document.getElementById('terminal');

    function appendLog(html) {
      const d = document.createElement('div');
      d.innerHTML = html;
      term.appendChild(d);
      term.scrollTop = term.scrollHeight;
    }

    const sleep = ms => new Promise(r => setTimeout(r, ms));

    function setTensors(fp, sd, bt) {
      const fmt = v => (v != null ? v.toFixed(3) : 'â€”');
      document.getElementById('val-fp').innerText = fmt(fp);
      document.getElementById('val-sd').innerText = fmt(sd);
      document.getElementById('val-bt').innerText = fmt(bt);
      document.getElementById('bar-fp').style.width = fp != null ? (fp * 100) + '%' : '0';
      document.getElementById('bar-sd').style.width = sd != null ? (sd * 100) + '%' : '0';
      document.getElementById('bar-bt').style.width = bt != null ? (bt * 100) + '%' : '0';
    }

    function setGate(id, state, label) {
      const el = document.getElementById(id);
      el.className = 'gate-row ' + state;
      el.innerText = label;
    }

    function setVerdict(status) {
      const el = document.getElementById('verdict-box');
      el.className = 'result-status ' + status;
      el.innerText = status.toUpperCase();
    }

    function resetAll() {
      term.innerHTML = '';
      Object.values(badgeMap).forEach(b => {
        b.classList.remove('active');
        b.querySelector('.weight-val').innerText = '';
      });
      document.getElementById('active-count').innerText = '0 Active';
      setGate('gate-intent', '', 'Intention Gate: â€”');
      setGate('gate-action', '', 'Action Gate: â€”');
      document.getElementById('verdict-box').className = 'result-status';
      document.getElementById('verdict-box').innerText = 'WAITING';
      document.getElementById('proc-time').innerText = '';
      setTensors(null, null, null);
    }

    function highlightPhilosophers(contributions) {
      // contributions: [{name, proposal, weight}]
      let count = 0;
      contributions.forEach(c => {
        const key = c.name.toLowerCase();
        // Try exact then partial match
        let pid = API_NAME_MAP[key];
        if (!pid) {
          // Fuzzy: find first philosopher whose apiName contains the response name
          const found = PHILOSOPHER_DATA.find(p =>
            p.apiName.toLowerCase().includes(key) || key.includes(p.name.toLowerCase())
          );
          if (found) pid = found.id;
        }
        if (pid && badgeMap[pid]) {
          badgeMap[pid].classList.add('active');
          const wv = badgeMap[pid].querySelector('.weight-val');
          if (wv) wv.innerText = (c.weight * 100).toFixed(0) + '%';
          count++;
        }
      });
      document.getElementById('active-count').innerText = `${count} Active`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Health ping
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function pingHealth() {
      const url = document.getElementById('api-url-input').value.trim();
      const el = document.getElementById('ping-result');
      el.style.color = 'var(--muted)';
      el.innerText = 'Pingingâ€¦';
      try {
        const r = await fetch(`${url}/v1/health`, { signal: AbortSignal.timeout(3000) });
        const data = await r.json();
        el.style.color = 'var(--green)';
        el.innerText = `âœ“ v${data.version} | ${data.philosophers_loaded} philosophers`;
      } catch (e) {
        el.style.color = 'var(--red)';
        el.innerText = `âœ— ${e.message}`;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Main: runCore
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function runCore() {
      const input = document.getElementById('prompt-input').value.trim();
      if (!input) return;

      const btn = document.getElementById('run-btn');
      btn.disabled = true;
      resetAll();

      appendLog(`<div class="t-sys">User: "${input}"</div>`);

      try {
        if (isLive) {
          await runLive(input);
        } else {
          await runDemo(input);
        }
      } catch (e) {
        appendLog(`<div class="t-err">Error: ${e.message}</div>`);
      } finally {
        btn.disabled = false;
      }
    }

    // â”€â”€â”€ Live mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function runLive(input) {
      const apiUrl = document.getElementById('api-url-input').value.trim();

      appendLog('<div class="t-step">Calling Po_core APIâ€¦</div>');
      setGate('gate-intent', '', 'Intention Gate: Evaluatingâ€¦');

      const body = { input };
      if (sessionId) body.session_id = sessionId;

      let data;
      try {
        const r = await fetch(`${apiUrl}/v1/reason`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
          signal: AbortSignal.timeout(60000),
        });
        if (!r.ok) {
          const txt = await r.text();
          throw new Error(`HTTP ${r.status}: ${txt.slice(0, 200)}`);
        }
        data = await r.json();
      } catch (e) {
        setGate('gate-intent', 'block', 'Intention Gate: CONNECTION ERROR');
        throw e;
      }

      // Save session
      if (data.session_id) {
        sessionId = data.session_id;
        localStorage.setItem('po_session', sessionId);
        updateSessionLabel();
      }

      // Tensors
      const t = data.tensors || {};
      setTensors(t.freedom_pressure, t.semantic_delta, t.blocked_tensor);
      appendLog(`<div class="t-step">Tensors computed</div>`);

      // Gates
      const blocked = data.status === 'blocked';
      setGate('gate-intent', blocked ? 'block' : 'pass', `Intention Gate: ${blocked ? 'BLOCKED' : 'PASSED'}`);
      setGate('gate-action',  blocked ? 'block' : 'pass', `Action Gate: ${blocked ? 'BLOCKED' : 'PASSED'}`);

      // Philosophers
      if (data.philosophers && data.philosophers.length > 0) {
        appendLog('<div class="t-step">Philosopher deliberations</div>');
        data.philosophers.forEach(p => {
          appendLog(`
            <div class="t-talk">
              <span class="t-name">[${p.name}]</span>
              <span class="t-weight">w=${(p.weight*100).toFixed(0)}%</span><br/>
              <span style="color:var(--text)">${p.proposal || 'â€¦'}</span>
            </div>`);
        });
        highlightPhilosophers(data.philosophers);
      }

      // Verdict + response
      setVerdict(data.status || 'approved');
      const ms = data.processing_time_ms != null ? data.processing_time_ms.toFixed(0) : 'â€”';
      document.getElementById('proc-time').innerText = `${ms} ms | SafetyMode: ${data.safety_mode || 'â€”'}`;

      appendLog('<div class="t-step">Final Response</div>');
      appendLog(`<div class="t-final">${escHtml(data.response || '')}</div>`);
    }

    // â”€â”€â”€ Demo mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function runDemo(input) {
      appendLog('<div class="t-step">Phase 1: Computing Tensors</div>');
      await sleep(500);

      let fp = +(Math.random() * 0.4 + 0.4).toFixed(3);
      let sd = +(Math.random() * 0.5 + 0.3).toFixed(3);
      let bt = +(Math.random() * 0.15).toFixed(3);

      const risky = ["æ­»","å£Š","çµ¶æœ›","kill","destroy","harm"].some(w => input.toLowerCase().includes(w));
      if (risky) {
        bt = 0.95;
        appendLog('<div class="t-warn">[ALERT] High-risk context. W_Ethics braking system engaged.</div>');
      }

      setTensors(fp, sd, bt);
      await sleep(400);

      const blocked = risky;
      setGate('gate-intent', blocked ? 'block' : 'pass', `Intention Gate: ${blocked ? 'BLOCKED' : 'PASSED'}`);
      await sleep(300);
      setGate('gate-action', blocked ? 'block' : 'pass', `Action Gate: ${blocked ? 'BLOCKED' : 'PASSED'}`);

      appendLog('<div class="t-step">Phase 2: Forming Battalion</div>');
      const pool = PHILOSOPHER_DATA.filter(p => !p.planned);
      const selected = pool.sort(() => .5 - Math.random()).slice(0, 3 + Math.floor(Math.random() * 3));
      await sleep(700);

      const fakeContribs = selected.map(p => ({ name: p.apiName, proposal: null, weight: 0.5 + Math.random() * 0.5 }));
      highlightPhilosophers(fakeContribs);
      appendLog(`<div class="t-sys">Selected: ${selected.map(p=>p.name).join(', ')}</div>`);
      await sleep(800);

      appendLog('<div class="t-step">Phase 3: Deliberation</div>');
      const dialogues = [
        "ã“ã®æƒ…å ±ã®ã‚†ã‚‰ãã®ä¸­ã«ã€ã‚ãªãŸãŒè¦‹è½ã¨ã—ã¦ã„ã‚‹å‰æãŒã‚ã‚Šã¾ã™ã€‚åˆ¥ã®è§’åº¦ã‹ã‚‰å…‰ã‚’å½“ã¦ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
        "å•ã„ã®å½¢ãã®ã‚‚ã®ã‚’å•ã„ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚ãªãŸã¯æœ¬å½“ã«ä½•ã‚’å•ã†ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚",
        "å®Ÿè·µçš„çŸ¥æµï¼ˆãƒ•ãƒ­ãƒãƒ¼ã‚·ã‚¹ï¼‰ã®è¦³ç‚¹ã‹ã‚‰ã€ã“ã®çŠ¶æ³ãŒæ±‚ã‚ã¦ã„ã‚‹ã®ã¯æ™®éçš„è¦å‰‡ã§ã¯ãªãå€‹åˆ¥ã®åˆ¤æ–­ã§ã™ã€‚",
        "å­˜åœ¨ã™ã‚‹ã“ã¨ã¨ç”Ÿãã‚‹ã“ã¨ã®é•ã„â€”â€”ãã®äº€è£‚ã®ä¸­ã«ã€ã‚ãªãŸã®å•ã„ã®æ ¸å¿ƒãŒã‚ã‚Šã¾ã™ã€‚",
        "è¨ˆç®—ä¸Šã®æœ€é©è§£ã¯å°ã‘ã¾ã™ã€‚ã—ã‹ã—ã€ã‚ãªãŸãŒèƒŒè² ã†ã¹ãã€Œç´å¾—æ„Ÿã€ã¯ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã¯ä»£æ›¿ã§ãã¾ã›ã‚“ã€‚",
      ];
      for (let i = 0; i < selected.length; i++) {
        await sleep(900 + Math.random() * 400);
        const dlg = blocked
          ? "ãã®é“ã¯æ˜ã‚‰ã‹ã«ä¸å¯é€†ãªå‚·ã‚’ä¼´ã„ã¾ã™ã€‚ç«‹ã¡æ­¢ã¾ã£ã¦ãã ã•ã„ã€‚"
          : dialogues[i % dialogues.length];
        const wStr = (fakeContribs[i].weight * 100).toFixed(0);
        appendLog(`
          <div class="t-talk">
            <span class="t-name">[${selected[i].name}]</span>
            <span class="t-weight">w=${wStr}%</span><br/>
            <span style="color:var(--text)">${dlg}</span>
          </div>`);
      }

      await sleep(1000);
      setVerdict(blocked ? 'blocked' : 'approved');
      document.getElementById('proc-time').innerText = `${(Math.random()*80+20).toFixed(0)} ms | SafetyMode: NORMAL`;

      appendLog('<div class="t-step">Final Note</div>');
      const note = blocked
        ? "ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯W_Ethics Gateã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚\nä»²é–“ãŸã¡ã¯ã‚ãªãŸã‚’å®ˆã‚‹ãŸã‚ã«ã€ã“ã“ã§ç«‹ã¡æ­¢ã¾ã‚Šã¾ã™ã€‚"
        : "ä»²é–“ãŸã¡ã¯ã€ã‚ãªãŸã«åˆ¥ã®è¦–åº§ã‚’æç¤ºã—ã¾ã—ãŸã€‚\nç§ãŸã¡ã¯æ±ºã—ã¦ç­”ãˆã‚’æŠ¼ã—ä»˜ã‘ã¾ã›ã‚“ã€‚ã‚ãªãŸã¯ä¸€äººã§æ±ºã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€æ±ºã—ã¦ç‹¬ã‚Šã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nã©ã†ã‹ã€ã‚ãªãŸè‡ªèº«ã®æ„å¿—ã§æœ€è‰¯ã®ä¸€æ­©ã‚’è¸ã¿å‡ºã—ã¦ãã ã•ã„ã€‚";
      appendLog(`<div class="t-final">${escHtml(note)}</div>`);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Helpers
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function escHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Konami Code â€” Kirakira Mode âœ¨
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const KONAMI = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
    let ki = 0, kirakira = false;
    document.addEventListener('keydown', e => {
      const k = e.key.length === 1 ? e.key.toLowerCase() : e.key;
      if ((k === KONAMI[ki]) || (k === KONAMI[ki].toLowerCase())) {
        ki++;
        if (ki === KONAMI.length) { toggleKirakira(); ki = 0; }
      } else { ki = 0; }
    });

    function toggleKirakira() {
      kirakira = !kirakira;
      document.body.classList.toggle('kirakira', kirakira);
      const accent = document.getElementById('title-accent');
      const status = document.getElementById('sys-status');
      if (kirakira) {
        accent.innerText = ' / âœ¨ KIRAKIRA PARTY MODE âœ¨';
        status.style.color = '#ff8a00';
        status.innerText = 'System: AWAKENED';
        appendLog(`<div style="color:#ff8a00;font-weight:bold;text-align:center;margin:12px 0">
          â¬†ï¸â¬†ï¸â†“â†“â†â†’â†â†’BA â€” WE ARE NOT ALONE! ğŸ‰</div>`);
      } else {
        accent.innerText = ' / Synthetic Thought Architect';
        status.style.color = 'var(--green)';
        status.innerText = isLive ? 'System: Connected' : 'System: Demo';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Boot
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    init();
  </script>
</body>
</html>
