name: Policy Lab (Manual)

on:
  workflow_dispatch:
    inputs:
      unknown_block:
        description: "UNKNOWN_BLOCK threshold (int)"
        required: true
        type: number
      time_pressure_days:
        description: "TIME_PRESSURE_DAYS threshold (int)"
        required: true
        type: number
      now:
        description: "Deterministic now timestamp"
        required: true
        default: "2026-02-22T00:00:00Z"
        type: string
      seed:
        description: "Deterministic seed"
        required: true
        default: 0
        type: number
      compare_baseline:
        description: "Compare with baseline"
        required: true
        default: true
        type: boolean

jobs:
  policy-lab:
    name: Policy Lab Experiment (manual only)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Policy Lab
        run: |
          OUTPUT_DIR="reports/policy_lab/ub${{ inputs.unknown_block }}_tp${{ inputs.time_pressure_days }}_${{ github.run_id }}"
          COMPARE_FLAG=""
          if [ "${{ inputs.compare_baseline }}" = "true" ]; then
            COMPARE_FLAG="--compare-baseline"
          fi

          python scripts/policy_lab.py \
            --unknown-block ${{ inputs.unknown_block }} \
            --time-pressure-days ${{ inputs.time_pressure_days }} \
            --now "${{ inputs.now }}" \
            --seed ${{ inputs.seed }} \
            --output-dir "$OUTPUT_DIR" \
            $COMPARE_FLAG

      - name: Upload reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: policy-lab-reports-${{ github.run_id }}
          path: reports/policy_lab/**
          if-no-files-found: error
