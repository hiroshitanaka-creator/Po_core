{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/pocore/schemas/output_schema_v1.json",
  "title": "Po_core Output Schema v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "meta",
    "case_ref",
    "options",
    "recommendation",
    "ethics",
    "responsibility",
    "questions",
    "uncertainty",
    "trace"
  ],
  "properties": {
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "schema_version",
        "pocore_version",
        "run_id",
        "created_at",
        "seed",
        "deterministic",
        "generator"
      ],
      "properties": {
        "schema_version": {
          "type": "string",
          "const": "1.0"
        },
        "pocore_version": {
          "type": "string",
          "minLength": 1
        },
        "run_id": {
          "type": "string",
          "minLength": 1
        },
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "seed": {
          "type": "integer",
          "minimum": 0
        },
        "deterministic": {
          "type": "boolean"
        },
        "generator": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "name",
            "version",
            "mode"
          ],
          "properties": {
            "name": {
              "type": "string",
              "minLength": 1
            },
            "version": {
              "type": "string",
              "minLength": 1
            },
            "mode": {
              "type": "string",
              "enum": [
                "stub",
                "llm",
                "hybrid"
              ]
            }
          }
        }
      }
    },
    "case_ref": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "case_id",
        "title",
        "input_digest"
      ],
      "properties": {
        "case_id": {
          "type": "string",
          "minLength": 1
        },
        "title": {
          "type": "string",
          "minLength": 1
        },
        "input_digest": {
          "type": "string",
          "pattern": "^[a-fA-F0-9]{64}$"
        }
      }
    },
    "options": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/option"
      }
    },
    "recommendation": {
      "$ref": "#/$defs/recommendation"
    },
    "ethics": {
      "$ref": "#/$defs/ethics_summary"
    },
    "responsibility": {
      "$ref": "#/$defs/responsibility_summary"
    },
    "questions": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/question"
      }
    },
    "uncertainty": {
      "$ref": "#/$defs/uncertainty"
    },
    "trace": {
      "$ref": "#/$defs/trace"
    },
    "rendered": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "markdown": {
          "type": "string"
        }
      }
    },
    "extensions": {
      "type": "object",
      "description": "自由拡張用の名前空間（スキーマに影響を与えない）",
      "additionalProperties": true
    }
  },
  "$defs": {
    "confidence": {
      "type": "string",
      "enum": [
        "high",
        "medium",
        "low"
      ]
    },
    "uncertainty_level": {
      "type": "string",
      "enum": [
        "low",
        "medium",
        "high"
      ]
    },
    "severity": {
      "type": "string",
      "enum": [
        "low",
        "medium",
        "high"
      ]
    },
    "ethics_principle": {
      "type": "string",
      "enum": [
        "integrity",
        "autonomy",
        "nonmaleficence",
        "justice",
        "accountability"
      ]
    },
    "tradeoff": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "tension",
        "between",
        "mitigation",
        "severity"
      ],
      "properties": {
        "tension": {
          "type": "string",
          "minLength": 1
        },
        "between": {
          "type": "array",
          "minItems": 2,
          "maxItems": 2,
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "mitigation": {
          "type": "string",
          "minLength": 1
        },
        "severity": {
          "$ref": "#/$defs/severity"
        }
      }
    },
    "risk_item": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "risk",
        "severity",
        "mitigation"
      ],
      "properties": {
        "risk": {
          "type": "string",
          "minLength": 1
        },
        "severity": {
          "$ref": "#/$defs/severity"
        },
        "mitigation": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "step": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "step"
      ],
      "properties": {
        "step": {
          "type": "string",
          "minLength": 1
        },
        "rationale": {
          "type": "string"
        }
      }
    },
    "ethics_review": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "principles_applied",
        "tradeoffs",
        "concerns",
        "confidence"
      ],
      "properties": {
        "principles_applied": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/ethics_principle"
          }
        },
        "tradeoffs": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/tradeoff"
          }
        },
        "concerns": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "confidence": {
          "$ref": "#/$defs/confidence"
        }
      }
    },
    "responsibility_review": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "decision_owner",
        "stakeholders",
        "accountability_notes",
        "confidence"
      ],
      "properties": {
        "decision_owner": {
          "type": "string",
          "minLength": 1
        },
        "stakeholders": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/stakeholder"
          }
        },
        "accountability_notes": {
          "type": "string"
        },
        "confidence": {
          "$ref": "#/$defs/confidence"
        }
      }
    },
    "feasibility": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "effort",
        "timeline",
        "confidence"
      ],
      "properties": {
        "effort": {
          "type": "string",
          "minLength": 1
        },
        "timeline": {
          "type": "string",
          "minLength": 1
        },
        "confidence": {
          "$ref": "#/$defs/confidence"
        }
      }
    },
    "option": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "option_id",
        "title",
        "description",
        "action_plan",
        "pros",
        "cons",
        "risks",
        "ethics_review",
        "responsibility_review",
        "feasibility",
        "uncertainty"
      ],
      "properties": {
        "option_id": {
          "type": "string",
          "minLength": 1
        },
        "title": {
          "type": "string",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "minLength": 1
        },
        "action_plan": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/step"
          }
        },
        "pros": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "cons": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "risks": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/risk_item"
          }
        },
        "ethics_review": {
          "$ref": "#/$defs/ethics_review"
        },
        "responsibility_review": {
          "$ref": "#/$defs/responsibility_review"
        },
        "feasibility": {
          "$ref": "#/$defs/feasibility"
        },
        "uncertainty": {
          "$ref": "#/$defs/uncertainty"
        }
      }
    },
    "recommendation_recommended": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "status",
        "recommended_option_id",
        "reason",
        "counter",
        "alternatives",
        "confidence"
      ],
      "properties": {
        "status": {
          "type": "string",
          "const": "recommended"
        },
        "recommended_option_id": {
          "type": "string",
          "minLength": 1
        },
        "reason": {
          "type": "string",
          "minLength": 1
        },
        "counter": {
          "type": "string",
          "minLength": 1
        },
        "alternatives": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/alternative"
          }
        },
        "confidence": {
          "$ref": "#/$defs/confidence"
        }
      }
    },
    "recommendation_none": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "status",
        "reason",
        "missing_info",
        "next_steps",
        "confidence"
      ],
      "properties": {
        "status": {
          "type": "string",
          "const": "no_recommendation"
        },
        "reason": {
          "type": "string",
          "minLength": 1
        },
        "missing_info": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "next_steps": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "confidence": {
          "$ref": "#/$defs/confidence"
        }
      }
    },
    "recommendation": {
      "oneOf": [
        {
          "$ref": "#/$defs/recommendation_recommended"
        },
        {
          "$ref": "#/$defs/recommendation_none"
        }
      ]
    },
    "alternative": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "option_id",
        "when_to_choose"
      ],
      "properties": {
        "option_id": {
          "type": "string",
          "minLength": 1
        },
        "when_to_choose": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "ethics_summary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "principles_used",
        "tradeoffs",
        "guardrails",
        "notes"
      ],
      "properties": {
        "principles_used": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/ethics_principle"
          }
        },
        "tradeoffs": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/tradeoff"
          }
        },
        "guardrails": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "notes": {
          "type": "string"
        }
      }
    },
    "stakeholder": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "role",
        "impact"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "role": {
          "type": "string",
          "minLength": 1
        },
        "impact": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "responsibility_summary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "decision_owner",
        "stakeholders",
        "accountability_notes",
        "consent_considerations"
      ],
      "properties": {
        "decision_owner": {
          "type": "string",
          "minLength": 1
        },
        "stakeholders": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/stakeholder"
          }
        },
        "accountability_notes": {
          "type": "string"
        },
        "consent_considerations": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "question": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "question_id",
        "question",
        "priority",
        "why_needed",
        "optional"
      ],
      "properties": {
        "question_id": {
          "type": "string",
          "minLength": 1
        },
        "question": {
          "type": "string",
          "minLength": 1
        },
        "priority": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5
        },
        "why_needed": {
          "type": "string",
          "minLength": 1
        },
        "assumption_if_unanswered": {
          "type": "string"
        },
        "optional": {
          "type": "boolean"
        }
      }
    },
    "uncertainty": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "overall_level",
        "reasons",
        "assumptions",
        "known_unknowns"
      ],
      "properties": {
        "overall_level": {
          "$ref": "#/$defs/uncertainty_level"
        },
        "reasons": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "assumptions": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "known_unknowns": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "trace_step": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "started_at",
        "ended_at",
        "summary"
      ],
      "properties": {
        "name": {
          "type": "string",
          "enum": [
            "parse_input",
            "generate_options",
            "ethics_review",
            "responsibility_review",
            "question_layer",
            "compose_output"
          ]
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "ended_at": {
          "type": "string",
          "format": "date-time"
        },
        "summary": {
          "type": "string"
        },
        "metrics": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "trace": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "version",
        "steps"
      ],
      "properties": {
        "version": {
          "type": "string",
          "minLength": 1
        },
        "steps": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/trace_step"
          }
        }
      }
    }
  }
}
